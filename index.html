<!doctype html>
  <link rel="stylesheet" href="style.css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <body>
    <div id="root"></div>
    <div id="export-image"></div>
    <script src="elm.js"></script>
    <script src="dist/goat-app_v1-0-0-rc.min.js"></script>
    <!-- <script src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script> -->
    <script>
      var isMac = navigator.userAgent.indexOf('Mac OS X') != -1
      var app = Elm.Main.embed(document.getElementById("root"), { isMac: isMac });
      var savedImage
      app.ports.exportToImage.subscribe(function(image) {
        savedImage = image;
        window.requestAnimationFrame(exportImage)
      })

      app.ports.listenForUpload.subscribe(function(className) {
        var target = document.querySelector('.' + className);
        target.addEventListener("dragover", function(e) { e.preventDefault(); });
        target.addEventListener("drop", function(e) {
        	  e.preventDefault()
        	  loadImage(e.dataTransfer.files[0])
        }, true);
      })

      var client = window.ZAFClient ? ZAFClient.init() : null;
      var isInZendeskAppContext = !!client;

      var DOMURL = window.URL || window.webkitURL || window;

      function loadImage(src) {
        if (!src.type.match(/image.*/)) {
          return
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          var contentType = 'image/png';
          var blob = b64toBlob(e.target.result.replace('data:image/png;base64,', ''), contentType);
          var editImageBlobUrl = DOMURL.createObjectURL(blob);
          var newImg = new Image()
          newImg.crossOrigin = 'anonymous'
          newImg.onload = function() {
            app.ports.newImage.send({
              url: editImageBlobUrl,
              width: this.naturalWidth,
              height: this.naturalHeight,
              originalWidth: this.naturalWidth,
              originalHeight: this.naturalHeight
            })
          }
          newImg.src = editImageBlobUrl
        }
        reader.readAsDataURL(src)
      }

      function getImages(html) {
        var div = document.createElement('div')
        div.innerHTML = html
        var images = div.querySelectorAll('img')
        return Array.prototype.map.call(images, toImageObject)
      }

      function toImageObject(image) {
        var id = image.getAttribute('data-imageuploadid')
        var originalWidth = parseFloat(image.getAttribute('data-original-width'));
        var originalHeight = parseFloat(image.getAttribute('data-original-height'));
        var width = parseFloat(image.style.width.replace('px', ''))
        var height = width / (originalWidth / originalHeight)
        return {
          id: id,
          url: image.src,
          originalWidth: originalWidth,
          originalHeight: originalHeight,
          width: width,
          height: height
        }
      }

      function toLocalImage(imageObject) {
        return new Promise(function(resolve) {
            const img = new Image()
            img.crossOrigin = 'anonymous'
            img.onload = function() {
              resolve({img, imageObject, status: 'ok'})
            }

            img.src = imageObject.url
        })
      }

      function getImageBlob(img, imageObject) {
        return new Promise(function(resolve) {
          var canvas = document.createElement("canvas")
          canvas.width = img.width
          canvas.height = img.height

          var ctx = canvas.getContext("2d")
          ctx.drawImage(img, 0, 0)

          var newImageObject = imageObject
          canvas.toBlob(function(blob) {
            newImageObject.url = DOMURL.createObjectURL(blob)
            resolve(newImageObject)
          })
        })
      }

      function b64toBlob(b64Data, contentType='', sliceSize=512) {
        var byteCharacters = atob(b64Data)
        var byteArrays = []
        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
          var slice = byteCharacters.slice(offset, offset + sliceSize)
          var byteNumbers = new Array(slice.length)
          for (var i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i)
          }
          var byteArray = new Uint8Array(byteNumbers)
          byteArrays.push(byteArray)
        }
        return new Blob(byteArrays, {type: contentType})
      }

      function autoScale(canvas) {
        // adapted from https://www.html5rocks.com/en/tutorials/canvas/hidpi/
        var context = canvas.getContext('2d')
        var devicePixelRatio = window.devicePixelRatio || 1
        var backingStoreRatio = context.webkitBackingStorePixelRatio ||
                              context.mozBackingStorePixelRatio ||
                              context.msBackingStorePixelRatio ||
                              context.oBackingStorePixelRatio ||
                              context.backingStorePixelRatio || 1

        var ratio = devicePixelRatio / backingStoreRatio

        if (devicePixelRatio !== backingStoreRatio) {
            var oldWidth = canvas.width
            var oldHeight = canvas.height

            canvas.width = oldWidth * ratio
            canvas.height = oldHeight * ratio

            canvas.style.width = oldWidth + 'px'
            canvas.style.height = oldHeight + 'px'

            context.scale(ratio, ratio)
        }
      }

      function exportImage() {
        var image = savedImage
        var canvas = document.createElement('canvas')
        canvas.crossOrigin='anonymous'
        canvas.width = image.width
        canvas.height = image.height
        autoScale(canvas)

        var ctx = canvas.getContext('2d')
        var data = document.getElementById('drawing').outerHTML
        var drawingImg = new Image()
        drawingImg.crossOrigin = 'anonymous'
        var svg = new Blob([data], {type: 'image/svg+xml'})
        var url = DOMURL.createObjectURL(svg)
        drawingImg.onload = function() {
          if (isInZendeskAppContext) {
            canvas.width = image.width
            canvas.height = image.height
            ctx.drawImage(document.querySelector('.image-to-annotate'), 0, 0, image.width, Math.round(image.height))
            ctx.drawImage(drawingImg, 0, 0, image.width, Math.round(image.height))

            client.get('ticket.comment').then(function(zaf) {
              var div = document.createElement('div')
              var comment = zaf['ticket.comment'].text
              div.innerHTML = comment
              div.querySelector('img[data-imageuploadid="' + image.id + '"]').outerHTML = ''
              client.set('ticket.comment.text', div.innerHTML).then(function() {
                client.invoke('ticket.editor.inlineImage', canvas.toDataURL())
                client.invoke('app.close')
              })
            })
          } else {
            ctx.drawImage(document.querySelector('.image-to-annotate'), 0, 0, image.originalWidth, image.originalHeight, 0, 0, image.width, Math.round(image.height))
            ctx.drawImage(drawingImg, 0, 0, image.width, Math.round(image.height))
            plopImageIntoDom(canvas, image)
          }
          DOMURL.revokeObjectURL(url)
        }
        drawingImg.src = url
      }

      function plopImageIntoDom(canvas, image) {
        canvas.toBlob(function(blob) {
          var exportImage = new Image()
          exportImage.crossOrigin = 'anonymous'
          exportImage.id = 'export-image'
          exportImage.src = DOMURL.createObjectURL(blob)
          exportImage.width = image.width
          exportImage.height = image.height
          document.body.replaceChild(exportImage, document.getElementById('export-image'))
        })
      }

      if (isInZendeskAppContext) {
        client.invoke('resize', { height: 320, width: 800 })
        client.on('pane.activated', readInImages)

        function readInImages(event) {
          client.get('ticket.comment').then(function(zaf) {
            var div = document.createElement('div')
            var comment = zaf['ticket.comment'].text
            div.innerHTML = comment
            var images = div.querySelectorAll('img')
            var imageObjects = Array.prototype.map.call(images, toImageObject)
            Promise.all(Array.prototype.map.call(imageObjects, toLocalImage))
              .then(function(allLocalImageData) {
                return Promise.all(Array.prototype.map.call(allLocalImageData, function(localData) {
                  return getImageBlob(localData.img, localData.imageObject)
                }))
              })
              .then(function(localImages) {
                app.ports.setImages.send(localImages)
              })
          })
        }
      }
    </script>
  </body>
