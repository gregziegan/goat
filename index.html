<!doctype html>
  <link rel="stylesheet" href="style.css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <body>
    <div id="root"></div>
    <div id="export-image"></div>
    <script src="elm.js"></script>
    <script src="dist/goat-app_v1-0-0-rc.min.js"></script>
    <script src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script>
     // polyfills
     if (!HTMLCanvasElement.prototype.toBlob) {
      Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
       value: function (callback, type, quality) {

         var binStr = atob( this.toDataURL(type, quality).split(',')[1] ),
             len = binStr.length,
             arr = new Uint8Array(len);

         for (var i = 0; i < len; i++ ) {
          arr[i] = binStr.charCodeAt(i);
         }

         callback( new Blob( [arr], {type: type || 'image/png'} ) );
       }
      });
     }
    </script>
    <script>
      // flags
      var isMac = navigator.userAgent.indexOf('Mac OS X') != -1;
      var client = window.ZAFClient ? ZAFClient.init() : null;
      var isInZendeskAppContext = !!client;


      var app = Elm.Main.embed(document.getElementById("root"), { isMac: isMac, inZendesk : isInZendeskAppContext });
      var savedImage;

      // ports
      app.ports.exportToImage.subscribe(function (image) {
        savedImage = image;
        window.requestAnimationFrame(exportImage);
      });

      app.ports.listenForUpload.subscribe(function () {
        var target = document.querySelector('.droparea');
        target.addEventListener("dragover", function (e) {
          e.preventDefault();
        });
        target.addEventListener("drop", function (e) {
          e.preventDefault();
          loadImage(e.dataTransfer.files[0]);
        }, true);
      });

      app.ports.requestImages.subscribe(function () {
        if (isInZendeskAppContext) {
          readInImagesFromZendesk();
        } else {
          var goats = [
            { id: '0', url: 'images/goat.jpg', width: 235, height: 276, originalWidth: 639, originalHeight: 751},
            { id: '0', url: 'images/goat2.jpg', width: 235, height: 276, originalWidth: 639, originalHeight: 751}
          ];
          readInImages(goats).then(function (localImages) {
            app.ports.setImages.send(localImages);
          });
        }
      });

      // zendesk listeners
      if (isInZendeskAppContext) {
        client.invoke('resize', { height: 320, width: 800 });
        client.on('pane.activated', readInImagesFromZendesk);
        client.on('pane.deactivated', function() {
          app.ports.reset.send(null);
        })
      }

      // helper functions
      function loadImage(src) {
        if (!src.type.match(/image.*/)) {
          return;
        }
        var reader = new FileReader();
        reader.onload = function (e) {
          var imageUrl = e.target.result;
          var contentType = 'image/png';
          var newImg = new Image();
          newImg.crossOrigin = 'anonymous';
          newImg.onload = function () {
            app.ports.newImage.send({
              id: '0',
              url: imageUrl,
              width: this.naturalWidth,
              height: this.naturalHeight,
              originalWidth: this.naturalWidth,
              originalHeight: this.naturalHeight
            });
          };
          newImg.src = imageUrl;
        };
        reader.readAsDataURL(src);
      }

      function toImageObject(image) {
        var id = image.getAttribute('data-imageuploadid');
        var originalWidth = parseFloat(image.getAttribute('data-original-width'));
        var originalHeight = parseFloat(image.getAttribute('data-original-height'));
        var width = parseFloat(image.style.width.replace('px', ''));
        var height = width / (originalWidth / originalHeight);
        return {
          id: id,
          url: image.src,
          originalWidth: originalWidth,
          originalHeight: originalHeight,
          width: width,
          height: height
        };
      }

      function toLocalImage(imageObject) {
        return new Promise(function (resolve) {
          var img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = function () {
            resolve({ img: img, imageObject: imageObject, status: 'ok' });
          };

          img.src = imageObject.url;
        });
      }

      function getImageUrl(img, imageObject) {
        return new Promise(function (resolve) {
          var canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;

          var ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          var newImageObject = imageObject;
          newImageObject.url = canvas.toDataURL("image/png");
          resolve(newImageObject);
        });
      }

      function exportImage() {
        var image = savedImage;
        var svg = document.getElementById( "drawing" );
        var svgData = new XMLSerializer().serializeToString( svg );

        var canvas = document.createElement( "canvas" );
        var ctx = canvas.getContext( "2d" );

        var img = document.createElement( "img" );
        img.onload = function() {
          ctx.drawImage( img, 0, 0 );
          if (isInZendeskAppContext) {
            client.get('ticket.comment').then(function (zaf) {
              var div = document.createElement('div');
              var comment = zaf['ticket.comment'].text;
              div.innerHTML = comment;
              var selectionBox = div.querySelector('span.zd-editor--rich-text-comment--resize-box');
              var imageToReplace = div.querySelector('img[data-imageuploadid="' + image.id + '"]');
              if (selectionBox && imageToReplace) {
                selectionBox.outerHTML = '';
              } else {
                imageToReplace.outerHTML = '';
              }
              client.set('ticket.comment.text', div.innerHTML).then(function () {
                client.invoke('ticket.editor.inlineImage', canvas.toDataURL('image/png'));
                client.invoke('app.close');
                app.ports.reset.send(null);
              });
            });
          } else {
            img.id = 'export-image';
            document.body.replaceChild(img, document.getElementById('export-image'));
          }
        }
        img.setAttribute( "src", "data:image/svg+xml;base64," + btoa( svgData ) );
      }

      function readInImagesFromZendesk() {
        client.get('ticket.comment').then(function (zaf) {
          var div = document.createElement('div');
          var comment = zaf['ticket.comment'].text;
          div.innerHTML = comment;
          var selectedImage = div.querySelector('span.zd-editor--rich-text-comment--resize-box img')
          if (selectedImage) {
            readInImages([toImageObject(selectedImage)])
              .then(function (localImages) {
                app.ports.newImage.send(localImages[0]);
              });
          } else {
            var images = div.querySelectorAll('img');
            var imageObjects = Array.prototype.map.call(images, toImageObject);
            readInImages(imageObjects).then(function (localImages) {
              app.ports.setImages.send(localImages);
            });
          }
        });
      }

      function readInImages(imageObjects) {
        return Promise.all(Array.prototype.map.call(imageObjects, toLocalImage)).then(function (allLocalImageData) {
          return Promise.all(Array.prototype.map.call(allLocalImageData, function (localData) {
            return getImageUrl(localData.img, localData.imageObject);
          }));
        })
      }
    </script>
  </body>
