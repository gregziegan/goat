<!doctype html>
  <link rel="stylesheet" href="style.css" />

  <body>
    <div id="root"></div>
    <canvas id="export" width=100 height=100 style="display:none;"></canvas>
    <div id="export-image"></div>
    <script src="elm.js"></script>
    <script src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
    <script>
      var app = Elm.Annotator.embed(document.getElementById("root"));
      app.ports.exportToImage.subscribe(function(image) {
        var canvas = document.getElementById('export')
        var ctx = canvas.getContext("2d")

        var img = new Image()
        img.onload = function() {
          var drawing = document.querySelector('#annotation-app canvas')
          canvas.width = image.width;
          canvas.height = image.height;
          ctx.drawImage(img, 0, 0, image.width, image.height)
          ctx.drawImage(drawing, 0, 0, image.width, image.height)
          canvas.toBlob(blob => {
            var exportImage = new Image()
            exportImage.id = 'export-image'
            exportImage.src = URL.createObjectURL(blob)
            document.body.replaceChild(exportImage, document.getElementById('export-image'))
          })
        }
        img.src = image.url
      });

      app.ports.drawMask.subscribe(function(className) {
        var canvas = document.querySelector('.' + className + ' canvas')
        // if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = canvas.width
        offscreenCanvas.height = canvas.height
        var octx = offscreenCanvas.getContext('2d')
        octx.fillStyle = 'rgba(100, 100, 100, 0.5)'
        octx.fillRect(0, 0, canvas.width, canvas.height)
        octx.globalCompositeOperation = "destination-out";
        octx.drawImage(canvas, 0, 0, canvas.width, canvas.height)
        offscreenCanvas.toBlob(blob => {
          app.ports.updateMask.send(URL.createObjectURL(blob))
        })
      })

      const testEditorHtml = '<div><p>​<img data-imageuploadid="0.601161934050189" src="goat.jpg" data-upload-token="fETc6elwJa6YPIJqhj8lTS4Ir" data-inline-attachment="true" data-upload-id="7000414807" data-original-height="751" data-original-width="639" style="width: 235px; height: 276.189px;">​<br></p><p>goat pics</p><p><img data-imageuploadid="0.641161934050189" src="goat2.jpg" data-upload-token="fETc6elwJaasPIJqhj8lTS4Ir" data-inline-attachment="true" data-upload-id="7020414807" data-original-height="751" data-original-width="639" style="width: 235px; height: 276.189px;">​<br></p></div>';
      const div = document.createElement('div')
      div.innerHTML = testEditorHtml
      const images = div.querySelectorAll('img');

      function toImageObject(image) {
        const width = parseFloat(image.style.width.replace('px', ''));
        const height = parseFloat(image.style.height.replace('px', ''));
        return {
          url: image.src,
          originalWidth: parseFloat(image.getAttribute('data-original-width')),
          originalHeight: parseFloat(image.getAttribute('data-original-height')),
          width: width,
          height: height
        }
      }
      const imageObjects = Array.prototype.map.call(images, toImageObject);
      app.ports.setImages.send(imageObjects)

    </script>
  </body>
